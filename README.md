# [ğŸŒ Web-SWMM é¡¹ç›®](https://www.bilibili.com/video/BV1p7eFz6EBj/)

## 1ã€é¡¹ç›®ä»‹ç»

Web-SWMM é¡¹ç›®æ—¨åœ¨å°† SWMMï¼ˆStorm Water Management Modelï¼‰çš„ä¸€éƒ¨åˆ†åŠŸèƒ½æ¬åˆ°ç½‘é¡µç«¯ï¼Œä»¥ä¾¿æ›´ç›´è§‚åœ°è¿›è¡Œæ¨¡å‹çš„æ“ä½œå’Œç®¡ç†ï¼Œä¸ºæŸäº›ä»»åŠ¡æä¾› SWMM è°ƒç”¨æ”¯æŒã€‚

å‰ç«¯ä½¿ç”¨ **Vue** å’Œ **Cesium** å®ç°äº¤äº’å¼ç•Œé¢å’Œä¸‰ç»´å¯è§†åŒ–ï¼Œåç«¯ä½¿ç”¨ **FastAPI** å’Œ **swmm-api** æä¾›é«˜æ•ˆçš„ API æœåŠ¡å’Œ SWMM æ–‡ä»¶çš„æ“ä½œèƒ½åŠ›ã€‚

---

## 2ã€å®ç°åŠŸèƒ½

è¯¥é¡¹ç›®å®ç°äº†ä»¥ä¸‹ SWMM åŠŸèƒ½ï¼š

1. **èŠ‚ç‚¹ç®¡ç†**ï¼š

   - å¢åˆ æ”¹æŸ¥èŠ‚ç‚¹ã€‚
   - æ›´æ–°èŠ‚ç‚¹çš„åæ ‡ã€å…¥æµä¿¡æ¯åŠå…³è”çš„æ—¶é—´åºåˆ—ã€‚

2. **æ¸ é“ç®¡ç†**ï¼š

   - å¢åˆ æ”¹æŸ¥æ¸ é“ï¼ˆç®¡é“ï¼‰ã€‚
   - æ›´æ–°æ¸ é“çš„æ–­é¢ä¿¡æ¯åŠèµ·ç‚¹ã€ç»ˆç‚¹èŠ‚ç‚¹ã€‚

3. **å‡ºå£ç®¡ç†**ï¼š

   - å¢åˆ æ”¹æŸ¥å‡ºå£èŠ‚ç‚¹ã€‚
   - æ›´æ–°å‡ºå£çš„åæ ‡å’Œå‡ºæµç±»å‹ã€‚

4. **å­æ±‡æ°´åŒºç®¡ç†**ï¼š

   - **äº§æµæ¨¡å‹å‚æ•°ç®¡ç†**ï¼šå¢åˆ æ”¹æŸ¥å­æ±‡æ°´åŒºï¼Œè®¾ç½®åç§°ã€é›¨é‡è®¡ã€å‡ºæ°´å£ã€é¢ç§¯ã€ä¸é€æ°´ç‡ã€å®½åº¦å’Œå¡åº¦å‚æ•°ã€‚
   - **æ±‡æµæ¨¡å‹å‚æ•°ç®¡ç†**ï¼šç®¡ç†ä¸é€æ°´å’Œé€æ°´å­åŒºçš„æ›¼å®ç²—ç³™ç³»æ•°ã€å‡¹é™·å‚¨å­˜é‡ã€å¾„æµæµå‘å’Œæµå‘ç™¾åˆ†æ¯”ã€‚
   - **ä¸‹æ¸—æ¨¡å‹å‚æ•°ç®¡ç†**ï¼šç®¡ç†éœé¡¿ä¸‹æ¸—æ¨¡å‹å‚æ•°ï¼ŒåŒ…æ‹¬æœ€å¤§å…¥æ¸—é€Ÿç‡ã€æœ€å°å…¥æ¸—é€Ÿç‡ã€è¡°å‡å¸¸æ•°ã€å¹²ç‡¥æ—¶é—´å’Œæœ€å¤§å…¥æ¸—ä½“ç§¯ã€‚
   - **è¾¹ç•Œæ•°æ®ç®¡ç†**ï¼šç¼–è¾‘å’Œä¿å­˜å­æ±‡æ°´åŒºçš„å¤šè¾¹å½¢è¾¹ç•Œï¼Œæ”¯æŒ WGS84 å’Œ UTM åæ ‡ç³»ä¹‹é—´çš„è‡ªåŠ¨è½¬æ¢ã€‚
   - **æ•°æ®ä¸€è‡´æ€§ç»´æŠ¤**ï¼šåœ¨å­æ±‡æ°´åŒºé‡å‘½åæ—¶ï¼Œè‡ªåŠ¨æ›´æ–°å…³è”çš„æ±‡æµã€ä¸‹æ¸—å’Œå¤šè¾¹å½¢æ•°æ®çš„åç§°å¼•ç”¨ã€‚

5. **æ—¶é—´åºåˆ—ç®¡ç†**ï¼š

   - å¢åˆ æ”¹æŸ¥æ—¶é—´åºåˆ—ã€‚
   - æ”¯æŒæµé‡ï¼ˆINFLOWï¼‰å’Œé›¨é‡ï¼ˆRAINGAGEï¼‰ä¸¤ç§æ—¶é—´åºåˆ—æ¨¡å¼ã€‚
   - è·å–æ—¶é—´åºåˆ—çš„åç§°åˆ—è¡¨å’Œè¯¦ç»†ä¿¡æ¯ã€‚
   - æ—¶é—´åºåˆ—æ•°æ®çš„å¯¼å…¥å’Œå¯¼å‡ºï¼ˆJSONB æ ¼å¼å­˜å‚¨ï¼‰ã€‚

6. **æ–­é¢ç®¡ç†**ï¼š

   - å¢åˆ æ”¹æŸ¥ä¸è§„åˆ™æ–­é¢ã€‚
   - æ›´æ–°æ–­é¢ä¿¡æ¯åŠå…¶å…³è”çš„æ¸ é“ã€‚

7. **è®¡ç®—æ¨¡å—**ï¼š
   - è·å–å’Œæ›´æ–°è®¡ç®—é€‰é¡¹ã€‚
   - è¿è¡Œ SWMM æ¨¡å‹å¹¶æŸ¥è¯¢è®¡ç®—ç»“æœã€‚
   - è§£æè®¡ç®—é”™è¯¯æ—¥å¿—ï¼ŒååŠ©é—®é¢˜å®šä½ã€‚

---

## 3ã€ç›®å½•ç»“æ„

```bash
web-swmm/
â”œâ”€â”€ backend/                        # åç«¯ä»£ç 
â”‚   â”œâ”€â”€ apis/
â”‚   â”‚   â”œâ”€â”€ agent/                  # æ™ºèƒ½ä½“ç›¸å…³æ¥å£
â”‚   â”‚   â”‚   â””â”€â”€ chat.py             # æ™ºèƒ½ä½“å¯¹è¯æ¥å£
â”‚   â”‚   â”œâ”€â”€ calculate.py            # è®¡ç®—æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ conduit.py              # æ¸ é“ç®¡ç†æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ junction.py             # èŠ‚ç‚¹ç®¡ç†æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ outfall.py              # å‡ºå£ç®¡ç†æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ subcatchment.py         # å­æ±‡æ°´åŒºç®¡ç†æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ timeseries.py           # æ—¶é—´åºåˆ—ç®¡ç†æ¨¡å—
â”‚   â”‚   â””â”€â”€ transect.py             # æ–­é¢ç®¡ç†æ¨¡å—
â”‚   â”œâ”€â”€ schemas/
â”‚   â”œâ”€â”€ tools/                      # åç«¯å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ calculate.py            # è®¡ç®—ç›¸å…³å·¥å…·
â”‚   â”‚   â”œâ”€â”€ conduit.py              # æ¸ é“ç›¸å…³å·¥å…·
â”‚   â”‚   â”œâ”€â”€ junction.py             # èŠ‚ç‚¹ç›¸å…³å·¥å…·
â”‚   â”‚   â”œâ”€â”€ outfall.py              # å‡ºå£ç›¸å…³å·¥å…·
â”‚   â”‚   â”œâ”€â”€ subcatchment.py         # å­æ±‡æ°´åŒºç›¸å…³å·¥å…·
â”‚   â”‚   â””â”€â”€ webgis.py               # GIS ç›¸å…³å·¥å…·
â”‚   â”‚   â”œâ”€â”€ calculate.py            # è®¡ç®—æ¨¡å—æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ conduit.py              # æ¸ é“æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ junction.py             # èŠ‚ç‚¹æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ outfall.py              # å‡ºå£æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ result.py               # å“åº”ç»“æœæ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ subcatchment.py         # å­æ±‡æ°´åŒºæ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ timeseries.py           # æ—¶é—´åºåˆ—æ•°æ®æ¨¡å‹
â”‚   â”‚   â””â”€â”€ transect.py             # æ–­é¢æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ swmm/                       # SWMM è®¡ç®—æ–‡ä»¶å­˜å‚¨ç›®å½•
â”‚   â”‚   â”œâ”€â”€ swmm.inp                # æµ‹è¯•è¾“å…¥æ–‡ä»¶(å·².gitignore)
â”‚   â”‚   â””â”€â”€ swmm.inp.example        # æµ‹è¯•è¾“å…¥æ–‡ä»¶(ç¤ºä¾‹)
â”‚   â”œâ”€â”€ utils/                      # å·¥å…·æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ coordinate_converter.py # åæ ‡ç³»è½¬æ¢å·¥å…·
â”‚   â”‚   â”œâ”€â”€ logger.py			   # logger é…ç½®
â”‚   â”‚   â”œâ”€â”€ swmm_constant.py        # SWMM å¸¸é‡é…ç½®
â”‚   â”‚   â””â”€â”€ utils.py                # é€šç”¨å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ websocket_manager.py    # websocket ç®¡ç†å·¥å…·
â”‚   â”‚   â””â”€â”€ agent/                  # æ™ºèƒ½ä½“åº•å±‚å·¥å…·
â”‚   â”‚       â”œâ”€â”€ async_store_manager.py   # å¼‚æ­¥å­˜å‚¨ç®¡ç†
â”‚   â”‚       â”œâ”€â”€ graph_manager.py         # æ™ºèƒ½ä½“å›¾ç®¡ç†
â”‚   â”‚       â”œâ”€â”€ llm_manager.py           # å¤§æ¨¡å‹ç®¡ç†
â”‚   â”‚       â”œâ”€â”€ serial_tool_node.py      # ä¸²è¡Œå·¥å…·èŠ‚ç‚¹
â”‚   â”‚       â””â”€â”€  websocket_manager.py     # æ™ºèƒ½ä½“ websocket ç®¡ç†
â”‚   â”œâ”€â”€ .env                        # .env ç¯å¢ƒå˜é‡(å·².gitignore)
â”‚   â”œâ”€â”€ .env.example                # .env ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”‚   â”œâ”€â”€ app.py                      # åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ config.py                   # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ poetry.lock
â”‚   â””â”€â”€ pyproject.toml
â”œâ”€â”€ frontend/                       # å‰ç«¯ä»£ç 
â”‚   â”œâ”€â”€ public/
â”‚   â”‚   â””â”€â”€ favicon.ico
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ apis/                   # å‰ç«¯ axios è¯·æ±‚æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ calculate.js        # è®¡ç®—æ¨¡å—API
â”‚   â”‚   â”‚   â”œâ”€â”€ conduit.js          # æ¸ é“API
â”‚   â”‚   â”‚   â”œâ”€â”€ junction.js         # èŠ‚ç‚¹API
â”‚   â”‚   â”‚   â”œâ”€â”€ outfall.js          # å‡ºå£API
â”‚   â”‚   â”‚   â”œâ”€â”€ subcatchment.js     # å­æ±‡æ°´åŒºAPI
â”‚   â”‚   â”‚   â”œâ”€â”€ timeseries.js       # æ—¶é—´åºåˆ—API
â”‚   â”‚   â”‚   â””â”€â”€ transect.js         # æ–­é¢API
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ agent/                  # æ™ºèƒ½ä½“ç›¸å…³ç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AgentChatDialog.vue # æ™ºèƒ½ä½“å¯¹è¯ä¸»çª—å£
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ChatInput.vue       # æ™ºèƒ½ä½“è¾“å…¥æ¡†
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ConfirmBoxUI.vue    # æ™ºèƒ½ä½“ç¡®è®¤å¼¹çª—
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ EchartsUI.vue       # æ™ºèƒ½ä½“å›¾è¡¨ç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MessageItem.vue     # æ™ºèƒ½ä½“æ¶ˆæ¯é¡¹
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ MessageList.vue     # æ™ºèƒ½ä½“æ¶ˆæ¯åˆ—è¡¨
â”‚   â”‚   â”‚   â”œâ”€â”€ CalculateDialog.vue     # SWMMè®¡ç®—æ¨¡å—å¼¹çª—
â”‚   â”‚   â”‚   â”œâ”€â”€ CesiumContainer.vue     # Cesiumä¸‰ç»´åœ°å›¾ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ ConduitDialog.vue       # æ¸ é“å¼¹çª—
â”‚   â”‚   â”‚   â”œâ”€â”€ JunctionDialog.vue      # èŠ‚ç‚¹å¼¹çª—
â”‚   â”‚   â”‚   â”œâ”€â”€ LeftMenu.vue            # å·¦ä¾§èœå•ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ OutfallDialog.vue       # å‡ºå£å¼¹çª—
â”‚   â”‚   â”‚   â”œâ”€â”€ SubcatchmentDialog.vue  # å­æ±‡æ°´åŒºå¼¹çª—
â”‚   â”‚   â”‚   â”œâ”€â”€ TimeSeriesDialog.vue    # æ—¶é—´åºåˆ—å¼¹çª—
â”‚   â”‚   â”‚   â””â”€â”€ TransectDialog.vue      # æ–­é¢å¼¹çª—
â”‚   â”‚   â”œâ”€â”€ router/                 # è·¯ç”±é…ç½®
â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”œâ”€â”€ stores/                 # çŠ¶æ€ç®¡ç†
â”‚   â”‚   â”‚   â””â”€â”€ viewer.js
â”‚   â”‚   â”œâ”€â”€ utils/                  # å·¥å…·æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ constant.js         # å¸¸é‡å®šä¹‰
â”‚   â”‚   â”‚   â”œâ”€â”€ convert.js          # æ•°æ®è½¬æ¢å·¥å…·
â”‚   â”‚   â”‚   â”œâ”€â”€ entity.js           # å®ä½“æ“ä½œå·¥å…·
â”‚   â”‚   â”‚   â”œâ”€â”€ request.js          # HTTPè¯·æ±‚å·¥å…·
â”‚   â”‚   â”‚   â”œâ”€â”€ useCesium.js        # Cesiumç›¸å…³å·¥å…·
â”‚   â”‚   â”‚   â””â”€â”€ wsURL.js            # websocket åœ°å€å·¥å…·
â”‚   â”‚   â”œâ”€â”€ tools/                  # å‰ç«¯å·¥å…·å‡½æ•°
â”‚   â”‚   â”‚   â”œâ”€â”€ webgis.js           # GIS ç›¸å…³å·¥å…·
â”‚   â”‚   â”‚   â””â”€â”€ webui.js            # UI ç›¸å…³å·¥å…·
â”‚   â”‚   â”œâ”€â”€ views/
â”‚   â”‚   â”‚   â””â”€â”€ HomeView.vue
â”‚   â”‚   â”œâ”€â”€ App.vue
â”‚   â”‚   â””â”€â”€ main.js
â”‚   â”œâ”€â”€ .editorconfig
â”‚   â”œâ”€â”€ .prettierrc.json
â”‚   â”œâ”€â”€ eslint.config.js
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ jsconfig.json
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ pnpm-lock.yaml
â”‚   â””â”€â”€ vite.config.js
â”œâ”€â”€ docker-volumes/                 # DockeræŒ‚è½½ç›®å½•
â”‚   â”œâ”€â”€ nginx/                      # Nginxé…ç½®ç›®å½•
â”‚   â”‚   â”œâ”€â”€ html/                   # å‰ç«¯é™æ€æ–‡ä»¶ç›®å½•
â”‚   â”‚   â””â”€â”€ nginx.conf              # Nginxé…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ swmm/                       # SWMMæ–‡ä»¶æŒ‚è½½ç›®å½•
â”‚       â”œâ”€â”€ Minjiang_with_conduit.ini
â”‚       â”œâ”€â”€ Minjiang_with_conduit.inp
â”‚       â”œâ”€â”€ swmm_test.ini
â”‚       â””â”€â”€ swmm_test.inp
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ pg-docker-compose.yml           # ç‹¬ç«‹PostgreSQLæœåŠ¡çš„Composeæ–‡ä»¶
â”œâ”€â”€ Dockerfile
â””â”€â”€ README.md
```

## 4ã€å¯åŠ¨é¡¹ç›®

### 4-1. æœ¬åœ°å¯åŠ¨

#### **åç«¯å¯åŠ¨**

1. å‚è€ƒ`.env.example`ï¼Œå¤åˆ¶ç”Ÿæˆä¸€ä¸ª`.env`ç¯å¢ƒå˜é‡æ–‡ä»¶

2. å‚è€ƒ`/backend/swmm/swmm.inp.example`,å¤åˆ¶ç”Ÿæˆä¸€ä¸ªæµ‹è¯•`swmm.inp`æ–‡ä»¶

3. ä½¿ç”¨ docker é…ç½®`PostgreSQL`æ•°æ®åº“

   ```bash
   docker-compose -f pg-docker-compose.yml -p pg up
   ```

4. ç¡®ä¿å·²å®‰è£… Python 3.11 å’Œ `Poetry`ã€‚

5. å®‰è£…ä¾èµ–ï¼š

   ```bash
   poetry install
   ```

6. æ¿€æ´»è™šæ‹Ÿç¯å¢ƒï¼š

   ```bash
   poetry shell
   ```

7. å¯åŠ¨ FastAPI æœåŠ¡ï¼š
   ```bash
   python app.py
   ```

#### **å‰ç«¯å¯åŠ¨**

1. ç¡®ä¿å·²å®‰è£… Node.js å’Œ pnpmã€‚
2. å®‰è£…ä¾èµ–ï¼š
   ```bash
   pnpm install
   ```
3. å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼š
   ```bash
   pnpm dev
   ```

å‰ç«¯é»˜è®¤è¿è¡Œåœ¨ `http://localhost:5000`ï¼Œåç«¯è¿è¡Œåœ¨ `http://localhost:8080`ã€‚

---

### 4-2. ä½¿ç”¨ Docker éƒ¨ç½²

#### æ­¥éª¤

1. **ä¿®æ”¹ backend `.env`**

   ```bash
   # æ•°æ®åº“é…ç½®ï¼ˆæŒ‡å‘dockerå®¹å™¨çš„postgres)
   DB_HOST=postgres
   DB_PORT=5432
   # æ—¥å¿—é…ç½®
   LOG_LEVEL=INFO
   ```

2. **ä¿®æ”¹ frontend `./frontend/utils/request.js`**

   ```js
   const baseURL = "/api"; // åå‘ä»£ç†ï¼ˆéƒ¨ç½²æ—¶ä½¿ç”¨ï¼‰
   ```

3. **ä½¿ç”¨ Docker Compose å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼š**

   ```bash
      docker-compose up -d
   ```

4. **é…ç½® docker æŒ‚è½½æ–‡ä»¶**

   ```bash
   docker-volumes/
   â”œâ”€â”€ nginx/						 # æŒ‚è½½ nginx é…ç½®ç›®å½•
   â”‚   â”œâ”€â”€ html/                      # å‰ç«¯é™æ€æ–‡ä»¶ç›®å½•
   â”‚   â”‚   â”œâ”€â”€ index.html             # å‰ç«¯ build ä¹‹åçš„æ–‡ä»¶
   â”‚   â”‚   â””â”€â”€ ...
   â”‚   â”œâ”€â”€ nginx.conf                 # Nginx é…ç½®æ–‡ä»¶
   â”œâ”€â”€ swmm/                          # æŒ‚è½½ SWMM æ–‡ä»¶ç›®å½•
   â”‚   â””â”€â”€ swmm.inp                   # æŒ‚è½½ SWMM è¾“å…¥æ–‡ä»¶
   ```

   > nginx.conf

   ```nginx
   #user  root;
   worker_processes  1;
   events {
     worker_connections  1024;
   }
   http {
     include       mime.types;
     default_type  application/octet-stream;
     client_max_body_size 100M;  # å…è®¸æœ€å¤š 100MB çš„æ–‡ä»¶ä¸Šä¼ 
     sendfile        on;
     keepalive_timeout  65;
     server {
         listen       80;
         server_name  localhost;
         location / {
             root   /usr/share/nginx/html;
             try_files $uri $uri/ /index.html last; # è§£å†³åˆ·æ–°404é—®é¢˜
             index  index.html index.htm;
         }
         error_page   500 502 503 504  /50x.html;
         location = /50x.html {
             root   html;
         }

         # é…ç½®åç«¯æ¥å£åå‘ä»£ç†
         location /api/ {
             proxy_pass http://fastapi:8080/;
             proxy_http_version 1.1;
             proxy_set_header Upgrade $http_upgrade;
             proxy_set_header Connection "upgrade";
             proxy_set_header Host $host;
         }
     }
   }
   ```
